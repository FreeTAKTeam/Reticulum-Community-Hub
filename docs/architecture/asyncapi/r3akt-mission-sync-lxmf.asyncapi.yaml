asyncapi: "2.6.0"
id: "urn:r3akt:asyncapi:mission-sync-lxmf"
info:
  title: "R3AKT Mission Sync LXMF Contract"
  version: "0.1.0"
  description: >
    Data Sync contract mapped to current RCH/R3AKT terms and supported operations:
    Feed -> Mission, Chatroom -> Topic.
    Only endpoints currently present in ReticulumCommunityHub-OAS are included.
defaultContentType: application/json
tags:
  - name: mission
    description: Mission lifecycle and synchronization.
  - name: topic
    description: Topic (chatroom) lifecycle.
  - name: content
    description: Mission content operations.
servers:
  reticulum_lxmf:
    protocol: lxmf
    description: Reticulum LXMF transport for mission-sync commands and events.
    bindings:
      x-lxmf:
        delivery: at-least-once
        propagation_nodes: supported
        encryption: reticulum-e2e
        signature: required
        field_constants:
          FIELD_COMMANDS: "0x09"
          FIELD_RESULTS: "0x0A"
          FIELD_GROUP: "0x0B"
          FIELD_EVENT: "0x0D"
channels:
  r3akt.mission.commands:
    description: Mission-sync commands (`FIELD_COMMANDS` / `0x09`).
    x-lxmf-fields:
      required:
        - FIELD_COMMANDS
      optional:
        - FIELD_GROUP
    publish:
      operationId: publishMissionCommand
      message:
        oneOf:
          - $ref: "#/components/messages/MissionJoinCommand"
          - $ref: "#/components/messages/MissionLeaveCommand"
          - $ref: "#/components/messages/MissionEventsListCommand"
          - $ref: "#/components/messages/MissionMessageSendCommand"
          - $ref: "#/components/messages/TopicListCommand"
          - $ref: "#/components/messages/TopicCreateCommand"
          - $ref: "#/components/messages/TopicPatchCommand"
          - $ref: "#/components/messages/TopicDeleteCommand"
          - $ref: "#/components/messages/TopicSubscribeCommand"
          - $ref: "#/components/messages/MarkerListCommand"
          - $ref: "#/components/messages/MarkerCreateCommand"
          - $ref: "#/components/messages/MarkerPositionUpdateCommand"
          - $ref: "#/components/messages/ZoneListCommand"
          - $ref: "#/components/messages/ZoneCreateCommand"
          - $ref: "#/components/messages/ZonePatchCommand"
          - $ref: "#/components/messages/ZoneDeleteCommand"
  r3akt.mission.replies:
    description: Mission-sync command outcomes (`FIELD_RESULTS` / `0x0A`).
    x-lxmf-fields:
      required:
        - FIELD_RESULTS
      optional:
        - FIELD_GROUP
    subscribe:
      operationId: subscribeMissionReplies
      message:
        oneOf:
          - $ref: "#/components/messages/CommandAccepted"
          - $ref: "#/components/messages/CommandRejected"
          - $ref: "#/components/messages/CommandResult"
  r3akt.mission.events:
    description: Mission domain events and snapshots (`FIELD_EVENT` / `0x0D`).
    x-lxmf-fields:
      required:
        - FIELD_EVENT
      optional:
        - FIELD_GROUP
    subscribe:
      operationId: subscribeMissionEvents
      message:
        oneOf:
          - $ref: "#/components/messages/MissionEvent"
          - $ref: "#/components/messages/MissionSnapshot"
components:
  messages:
    MissionJoinCommand:
      name: MissionJoinCommand
      x-http-operation: "POST /RCH"
      x-capability-required:
        - mission.join
      payload:
        allOf:
          - $ref: "../schemas/command.json"
          - type: object
            properties:
              command_type:
                const: mission.join
              args: { $ref: "#/components/schemas/IdentityArgs" }
            required: [command_type, args]
    MissionLeaveCommand:
      name: MissionLeaveCommand
      x-http-operation: "PUT /RCH"
      x-capability-required:
        - mission.leave
      payload:
        allOf:
          - $ref: "../schemas/command.json"
          - type: object
            properties:
              command_type:
                const: mission.leave
              args: { $ref: "#/components/schemas/IdentityArgs" }
            required: [command_type, args]
    MissionEventsListCommand:
      name: MissionEventsListCommand
      x-http-operation: "GET /Events"
      x-capability-required:
        - mission.audit.read
      payload:
        allOf:
          - $ref: "../schemas/command.json"
          - type: object
            properties:
              command_type:
                const: mission.events.list
              args:
                type: object
                additionalProperties: false
            required: [command_type, args]
    MissionMessageSendCommand:
      name: MissionMessageSendCommand
      x-http-operation: "POST /Message"
      x-capability-required:
        - mission.message.send
      payload:
        allOf:
          - $ref: "../schemas/command.json"
          - type: object
            properties:
              command_type:
                const: mission.message.send
              args: { $ref: "#/components/schemas/MessageSendArgs" }
            required: [command_type, args]
    TopicListCommand:
      name: TopicListCommand
      x-http-operation: "GET /Topic"
      x-capability-required:
        - topic.read
      payload:
        allOf:
          - $ref: "../schemas/command.json"
          - type: object
            properties:
              command_type:
                const: topic.list
              args:
                type: object
                additionalProperties: false
            required: [command_type, args]
    TopicCreateCommand:
      name: TopicCreateCommand
      x-http-operation: "POST /Topic"
      x-capability-required:
        - topic.create
      payload:
        allOf:
          - $ref: "../schemas/command.json"
          - type: object
            properties:
              command_type:
                const: topic.create
              args: { $ref: "#/components/schemas/TopicWriteArgs" }
            required: [command_type, args]
    TopicPatchCommand:
      name: TopicPatchCommand
      x-http-operation: "PATCH /Topic"
      x-capability-required:
        - topic.write
      payload:
        allOf:
          - $ref: "../schemas/command.json"
          - type: object
            properties:
              command_type:
                const: topic.patch
              args: { $ref: "#/components/schemas/TopicWriteArgs" }
            required: [command_type, args]
    TopicDeleteCommand:
      name: TopicDeleteCommand
      x-http-operation: "DELETE /Topic"
      x-capability-required:
        - topic.delete
      payload:
        allOf:
          - $ref: "../schemas/command.json"
          - type: object
            properties:
              command_type:
                const: topic.delete
              args: { $ref: "#/components/schemas/TopicIdArgs" }
            required: [command_type, args]
    TopicSubscribeCommand:
      name: TopicSubscribeCommand
      x-http-operation: "POST /Topic/Subscribe"
      x-capability-required:
        - topic.subscribe
      payload:
        allOf:
          - $ref: "../schemas/command.json"
          - type: object
            properties:
              command_type:
                const: topic.subscribe
              args: { $ref: "#/components/schemas/TopicSubscribeArgs" }
            required: [command_type, args]
    MarkerListCommand:
      name: MarkerListCommand
      x-http-operation: "GET /api/markers"
      x-capability-required:
        - mission.content.read
      payload:
        allOf:
          - $ref: "../schemas/command.json"
          - type: object
            properties:
              command_type:
                const: mission.marker.list
              args:
                type: object
                additionalProperties: false
            required: [command_type, args]
    MarkerCreateCommand:
      name: MarkerCreateCommand
      x-http-operation: "POST /api/markers"
      x-capability-required:
        - mission.content.write
      payload:
        allOf:
          - $ref: "../schemas/command.json"
          - type: object
            properties:
              command_type:
                const: mission.marker.create
              args: { $ref: "#/components/schemas/MarkerCreateArgs" }
            required: [command_type, args]
    MarkerPositionUpdateCommand:
      name: MarkerPositionUpdateCommand
      x-http-operation: "PATCH /api/markers/{object_destination_hash}/position"
      x-capability-required:
        - mission.content.write
      payload:
        allOf:
          - $ref: "../schemas/command.json"
          - type: object
            properties:
              command_type:
                const: mission.marker.position.patch
              args: { $ref: "#/components/schemas/MarkerPositionArgs" }
            required: [command_type, args]
    ZoneListCommand:
      name: ZoneListCommand
      x-http-operation: "GET /api/zones"
      x-capability-required:
        - mission.zone.read
      payload:
        allOf:
          - $ref: "../schemas/command.json"
          - type: object
            properties:
              command_type:
                const: mission.zone.list
              args:
                type: object
                additionalProperties: false
            required: [command_type, args]
    ZoneCreateCommand:
      name: ZoneCreateCommand
      x-http-operation: "POST /api/zones"
      x-capability-required:
        - mission.zone.write
      payload:
        allOf:
          - $ref: "../schemas/command.json"
          - type: object
            properties:
              command_type:
                const: mission.zone.create
              args: { $ref: "#/components/schemas/ZoneWriteArgs" }
            required: [command_type, args]
    ZonePatchCommand:
      name: ZonePatchCommand
      x-http-operation: "PATCH /api/zones/{zone_id}"
      x-capability-required:
        - mission.zone.write
      payload:
        allOf:
          - $ref: "../schemas/command.json"
          - type: object
            properties:
              command_type:
                const: mission.zone.patch
              args: { $ref: "#/components/schemas/ZoneWriteArgs" }
            required: [command_type, args]
    ZoneDeleteCommand:
      name: ZoneDeleteCommand
      x-http-operation: "DELETE /api/zones/{zone_id}"
      x-capability-required:
        - mission.zone.delete
      payload:
        allOf:
          - $ref: "../schemas/command.json"
          - type: object
            properties:
              command_type:
                const: mission.zone.delete
              args: { $ref: "#/components/schemas/ZoneIdArgs" }
            required: [command_type, args]
    CommandAccepted:
      name: CommandAccepted
      x-lxmf-field: FIELD_RESULTS
      payload:
        type: object
        required: [command_id, status, accepted_at]
        properties:
          command_id: { type: string }
          correlation_id: { type: string }
          status: { type: string, const: accepted }
          accepted_at: { type: string, format: date-time }
          by_identity: { type: string }
    CommandRejected:
      name: CommandRejected
      x-lxmf-field: FIELD_RESULTS
      payload:
        type: object
        required: [command_id, status, reason_code]
        properties:
          command_id: { type: string }
          correlation_id: { type: string }
          status: { type: string, const: rejected }
          reason_code:
            type: string
            enum: [unauthorized, invalid_payload, unknown_command, unsupported_operation, internal_error]
          reason: { type: string }
          required_capabilities:
            type: array
            items: { type: string }
    CommandResult:
      name: CommandResult
      x-lxmf-field: FIELD_RESULTS
      payload:
        type: object
        required: [command_id, status, result]
        properties:
          command_id: { type: string }
          correlation_id: { type: string }
          status: { type: string, const: result }
          result:
            type: object
            additionalProperties: true
    MissionEvent:
      name: MissionEvent
      x-lxmf-field: FIELD_EVENT
      payload:
        allOf:
          - $ref: "../schemas/event.json"
          - type: object
            properties:
              event_type:
                type: string
                enum:
                  - mission.joined
                  - mission.left
                  - mission.events.listed
                  - mission.message.sent
                  - mission.topic.created
                  - mission.topic.updated
                  - mission.topic.deleted
                  - mission.topic.subscribed
                  - mission.marker.created
                  - mission.marker.position.updated
                  - mission.zone.created
                  - mission.zone.updated
                  - mission.zone.deleted
              payload:
                oneOf:
                  - $ref: "#/components/schemas/Mission"
                  - $ref: "#/components/schemas/Topic"
                  - $ref: "#/components/schemas/MissionChange"
                  - $ref: "#/components/schemas/MarkerRef"
                  - $ref: "#/components/schemas/ZoneRef"
    MissionSnapshot:
      name: MissionSnapshot
      x-lxmf-field: FIELD_EVENT
      payload:
        allOf:
          - $ref: "../schemas/object.json"
          - type: object
            properties:
              object_type: { const: mission.snapshot }
              state: { $ref: "#/components/schemas/Mission" }
            required: [object_type, state]
  schemas:
    MissionRole:
      type: string
      enum: [MISSION_OWNER, MISSION_SUBSCRIBER, MISSION_READONLY_SUBSCRIBER]
    Mission:
      type: object
      required: [mission_id, topic]
      properties:
        mission_id: { type: string }
        name: { type: string }
        description: { type: string }
        topic: { $ref: "#/components/schemas/Topic" }
        default_role: { $ref: "#/components/schemas/MissionRole" }
        owner_role: { $ref: "#/components/schemas/MissionRole" }
        invite_only: { type: boolean }
    Topic:
      type: object
      required: [topic_id]
      properties:
        topic_id: { type: string }
        topic_name: { type: string }
        topic_path: { type: string }
        topic_description: { type: string }
    MissionChange:
      type: object
      required: [uid, mission_id, timestamp]
      properties:
        uid: { type: string }
        mission_id: { type: string }
        timestamp: { type: string, format: date-time }
        notes: { type: string }
        team_member_rns_identity: { type: string }
    MarkerRef:
      type: object
      required: [marker_id]
      properties:
        marker_id: { type: string }
        name: { type: string }
        lat: { type: number }
        lon: { type: number }
    ZoneRef:
      type: object
      required: [zone_id]
      properties:
        zone_id: { type: string }
        name: { type: string }
    IdentityArgs:
      type: object
      additionalProperties: false
      required: [identity]
      properties:
        identity: { type: string }
    MessageSendArgs:
      type: object
      additionalProperties: false
      required: [content]
      properties:
        content: { type: string }
        topic_id: { type: string }
        destination: { type: string }
    TopicIdArgs:
      type: object
      additionalProperties: false
      required: [id]
      properties:
        id: { type: string }
    TopicWriteArgs:
      type: object
      additionalProperties: false
      required: [topic_id]
      properties:
        topic_id: { type: string }
        topic_name: { type: string }
        topic_path: { type: string }
        topic_description: { type: string }
    TopicSubscribeArgs:
      type: object
      additionalProperties: false
      required: [topic_id]
      properties:
        topic_id: { type: string }
        destination: { type: string }
        reject_tests: { type: integer }
        metadata:
          type: object
          additionalProperties: true
    MarkerCreateArgs:
      type: object
      additionalProperties: true
      properties:
        name: { type: string }
        symbol: { type: string }
        marker_type: { type: string }
        lat: { type: number }
        lon: { type: number }
    MarkerPositionArgs:
      type: object
      additionalProperties: false
      required: [object_destination_hash, lat, lon]
      properties:
        object_destination_hash: { type: string }
        lat: { type: number }
        lon: { type: number }
    ZoneWriteArgs:
      type: object
      additionalProperties: false
      required: [zone_id]
      properties:
        zone_id: { type: string }
        name: { type: string }
        points:
          type: array
          minItems: 3
          items:
            type: object
            required: [lat, lon]
            properties:
              lat: { type: number }
              lon: { type: number }
    ZoneIdArgs:
      type: object
      additionalProperties: false
      required: [zone_id]
      properties:
        zone_id: { type: string }
