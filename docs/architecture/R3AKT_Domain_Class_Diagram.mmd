classDiagram
    direction LR

    class Topic {
        +string topic_id
        +string topic_name
        +string topic_path
        +string topic_description
    }

    class Subscriber {
        +string subscriber_id
        +string destination
        +string topic_id
        +int reject_tests
        +dict metadata
    }

    class NodeRecord {
        +string node_id
        +NodeType node_type
        +RegisterNodeMetadata metadata
    }

    class NodeStats {
        +float first_seen_ts
        +float last_seen_ts
        +float battery_pct
        +float signal_quality
    }

    class Client {
        +string identity
        +datetime last_seen
        +string display_name
        +dict metadata
    }

    class IdentityStatus {
        +string identity
        +string status
        +datetime last_seen
        +string display_name
        +dict metadata
        +bool is_banned
        +bool is_blackholed
    }

    class IdentityStateRecord {
        +string identity
        +bool is_banned
        +bool is_blackholed
        +datetime updated_at
    }

    class IdentityAnnounceRecord {
        +string destination_hash
        +string display_name
        +datetime first_seen
        +datetime last_seen
        +string source_interface
    }

    class FileAttachment {
        +int file_id
        +string name
        +string path
        +string category
        +int size
        +string media_type
        +string topic_id
    }

    class ChatAttachment {
        +int file_id
        +string category
        +string name
        +int size
        +string media_type
    }

    class ChatMessage {
        +string message_id
        +string direction
        +string scope
        +string state
        +string content
        +string source
        +string destination
        +string topic_id
        +datetime created_at
        +datetime updated_at
    }

    class Marker {
        +string local_id
        +string object_destination_hash
        +string origin_rch
        +string object_identity_storage_key
        +string marker_type
        +string symbol
        +string name
        +string category
        +float lat
        +float lon
        +datetime time
        +datetime stale_at
    }

    class Telemeter {
        +int id
        +string peer_dest
        +datetime time
    }

    class Sensor {
        +int id
        +int sid
        +float stale_time
        +bytes data
        +bool synthesized
    }

    class TelemetryLocation {
        +float latitude
        +float longitude
        +float altitude
        +float speed
        +float bearing
        +float accuracy
        +datetime last_update
    }

    class MissionStatus {
        <<enumeration>>
        PLANNED
        ACTIVE
        ON_HOLD
        COMPLETED
    }

    class TaskStatus {
        <<enumeration>>
        OPEN
        IN_PROGRESS
        BLOCKED
        DONE
    }

    class Mission {
        +string mission_id
        +string mission_name
        +MissionStatus status
        +string owner_identity
        +datetime created_at
        +datetime updated_at
    }

    class Task {
        +string task_id
        +string mission_id
        +string title
        +string details
        +TaskStatus status
        +string assignee_identity
        +datetime due_at
        +datetime created_at
        +datetime updated_at
    }

    class SitrepPriority {
        <<enumeration>>
        LOW
        ROUTINE
        HIGH
        CRITICAL
    }

    class TelemetryCoordinateRef {
        +int telemeter_id
        +int sensor_id
        +datetime sampled_at
    }

    class Sitrep {
        +string sitrep_id
        +SitrepPriority priority
        +TelemetryCoordinateRef coordinates_ref
        +string notes
        +datetime timestamp
        +string origin_identity
    }

    class SitrepDatapack {
        +string schema_version
        +string message_type
        +bytes payload
        +datetime created_at
    }

    class ReticulumEnvelope {
        +string source_identity
        +string destination_hash
        +bool encrypted
        +bytes ciphertext
        +bytes signature
    }

    class SitrepGenerator {
        +SitrepDatapack to_datapack(Sitrep sitrep)
        +ReticulumEnvelope to_reticulum_packet(SitrepDatapack datapack)
    }

    class SitrepParser {
        +Sitrep parse_datapack(SitrepDatapack datapack)
        +Sitrep parse_envelope(ReticulumEnvelope envelope)
    }

    class MissionChange {
        +string mission_change_id
        +string mission_id
        +string task_id
        +string change_type
        +string source_identity
        +string sitrep_id
        +dict payload
        +datetime created_at
    }

    class LogEntry {
        +string log_entry_id
        +string mission_id
        +string task_id
        +string level
        +string category
        +string message
        +datetime created_at
        +dict metadata
    }

    Topic "1" o-- "0..*" Subscriber : has
    Topic "1" o-- "0..*" FileAttachment : scopes
    Topic "1" o-- "0..*" ChatMessage : carries
    ChatMessage "1" o-- "0..*" ChatAttachment : includes
    ChatAttachment --> FileAttachment : references file_id

    Subscriber --> NodeRecord : destination/subscriber_id
    NodeRecord "1" o-- "1" NodeStats : runtime_status

    Client ..> IdentityStatus : contributes
    IdentityStateRecord ..> IdentityStatus : moderation_flags
    IdentityAnnounceRecord ..> IdentityStatus : announce_metadata

    NodeRecord --> Telemeter : peer_dest
    Telemeter "1" o-- "0..*" Sensor : captures
    Sensor <|-- TelemetryLocation
    Marker ..> Telemeter : emitted_as_telemetry

    Mission --> MissionStatus : state
    Task --> TaskStatus : state
    Mission "1" o-- "0..*" Task : contains

    Sitrep --> SitrepPriority : uses
    Sitrep --> TelemetryCoordinateRef : coordinates_ref
    Sitrep ..> Mission : mission_context
    Sitrep ..> Task : task_context
    TelemetryCoordinateRef --> Telemeter : telemeter_id
    TelemetryCoordinateRef --> TelemetryLocation : sensor_id/location

    SitrepGenerator ..> Sitrep : serializes
    SitrepGenerator --> SitrepDatapack : emits compact packet
    SitrepDatapack --> ReticulumEnvelope : wrapped_for_transport

    ReticulumEnvelope ..> SitrepParser : imported_packet
    SitrepParser --> Sitrep : reconstructs
    SitrepParser --> MissionChange : logs SITREP_IMPORTED
    SitrepParser --> LogEntry : writes audit log
    MissionChange --> Mission : references
    MissionChange ..> Task : optional_target
    MissionChange --> Sitrep : references
    LogEntry ..> Mission : context
    LogEntry ..> Task : context
    LogEntry ..> MissionChange : contextual_link
